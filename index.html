<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>CSV to QDC Codebook Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-drop-area {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-drop-area.dragover {
            background-color: #e0f2fe;
            border-color: #0284c7;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-8 md:p-12">
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">CSV to QDC Converter</h1>
            <p class="mt-2 text-slate-600">A simple tool to convert your codebook from a CSV file to an NVivo-compatible .qdc file.</p>
        </div>

        <div id="file-drop-area" class="mt-8 border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer">
            <input type="file" id="file-input" class="hidden" accept=".csv">
            <div id="upload-prompt">
                <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <p class="mt-4 text-lg text-slate-600">
                    <span class="font-semibold text-sky-600">Click to upload</span> or drag and drop
                </p>
                <p class="text-sm text-slate-500">CSV files only</p>
            </div>
            <div id="file-info" class="hidden text-left">
                <p class="font-semibold text-slate-700">Selected File:</p>
                <p id="file-name" class="text-sky-700 truncate"></p>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <button id="convert-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-200 disabled:bg-slate-300 disabled:cursor-not-allowed">
                Convert and Download
            </button>
        </div>
        
        <div id="message-box" class="mt-6 p-4 rounded-md text-center hidden"></div>

        <div class="mt-8 pt-6 border-t border-slate-200">
            <h2 class="text-lg font-semibold text-slate-800">Instructions</h2>
            <ul class="mt-2 list-disc list-inside text-slate-600 space-y-1">
                <li>Your CSV file's first row should be a header (e.g., "Code Name", "Description"). It will be skipped.</li>
                <li>**Column 1:** The name of the code (e.g., "1.1 External Pressure").</li>
                <li>**Column 2:** A description for the code.</li>
                <li>The script creates a flat list of codes, perfect for manual organization in NVivo.</li>
                <li>ðŸ”’ <strong>Privacy and Security:</strong> This tool runs entirely in your web browser using JavaScript. Your files are not uploaded to any server. The conversion process happens locally on your own computer.</li>
            </ul>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-input');
        const convertBtn = document.getElementById('convert-btn');
        const uploadPrompt = document.getElementById('upload-prompt');
        const fileInfo = document.getElementById('file-info');
        const fileNameEl = document.getElementById('file-name');
        const messageBox = document.getElementById('message-box');

        let csvContent = null;
        convertBtn.disabled = true;

        // --- Event Listeners ---
        fileDropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        convertBtn.addEventListener('click', processConversion);

        // Drag and Drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.remove('dragover'), false);
        });
        fileDropArea.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) {
                resetUI();
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('error', 'Invalid file type. Please upload a .csv file.');
                resetUI();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                csvContent = event.target.result;
                fileNameEl.textContent = file.name;
                uploadPrompt.classList.add('hidden');
                fileInfo.classList.remove('hidden');
                convertBtn.disabled = false;
                messageBox.classList.add('hidden');
            };
            reader.onerror = function() {
                showMessage('error', 'Error reading file.');
                resetUI();
            };
            reader.readAsText(file, 'UTF-8');
        }

        function resetUI() {
            fileInput.value = '';
            csvContent = null;
            uploadPrompt.classList.remove('hidden');
            fileInfo.classList.add('hidden');
            convertBtn.disabled = true;
        }
        
        function showMessage(type, text) {
            messageBox.textContent = text;
            messageBox.className = 'mt-6 p-4 rounded-md text-center'; // Reset classes
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            messageBox.classList.remove('hidden');
        }

        function processConversion() {
            if (!csvContent) {
                showMessage('error', 'No file content to process. Please select a file first.');
                return;
            }

            try {
                const qdcXml = createQdcContent(csvContent);
                if (qdcXml) {
                    downloadFile(qdcXml, 'codebook.qdc');
                } else {
                    showMessage('error', 'Could not generate QDC file. The CSV might be empty or formatted incorrectly.');
                }
            } catch (e) {
                showMessage('error', `An unexpected error occurred: ${e.message}`);
                console.error(e);
            }
        }

        // --- Core Conversion Logic (Translated from Python) ---

        /**
         * Generates a UUID.
         * @returns {string} A version 4 UUID.
         */
        function generateUuid() {
            return crypto.randomUUID();
        }

        /**
         * Creates the QDC XML string from the raw text content of a CSV file.
         * @param {string} csvFileContent - The full text of the uploaded CSV.
         * @returns {string|null} The QDC XML string or null if an error occurs.
         */
        function createQdcContent(csvFileContent) {
            const HEADER = `<?xml version="1.0" encoding="UTF-8"?>
<CodeBook xmlns="urn:QDA-XML:codebook:1:0">
<Codes>`;
            const FOOTER = `</Codes>
</CodeBook>`;
            const COLOURS = ['#00FF00', '#FF0000', '#FFFF00', '#0000FF', '#008080', '#00FFFF', '#FF00FF', '#008000'];
            let colourIndex = 0;

            let xmlParts = [];
            
            const rows = csvFileContent.trim().split('\n');
            rows.shift(); // Skip header

            if (rows.length === 0) {
                return null;
            }

            rows.forEach(rowStr => {
                if (!rowStr.trim()) return;

                // New logic to handle commas inside the description field.
                let label = '';
                let description = '';
                const firstCommaIndex = rowStr.indexOf(',');

                if (firstCommaIndex === -1) {
                    // No comma, entire line is the label
                    label = rowStr.trim();
                } else {
                    // Comma found, split into label and description
                    label = rowStr.substring(0, firstCommaIndex).trim();
                    description = rowStr.substring(firstCommaIndex + 1).trim();
                }

                // Clean up any surrounding quotes
                label = label.replace(/^"|"$/g, '');
                description = description.replace(/^"|"$/g, '');
                
                if (!label) return;

                const guid = generateUuid();
                const colour = COLOURS[colourIndex % COLOURS.length];
                colourIndex++;
                
                const colourAttr = `color="${colour}"`;
                const isCodable = 'true';
                const name = label;

                let openingTag = `<Code ${colourAttr} guid="${guid}" isCodable="${isCodable}" name="${name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')}"`;

                if (!description) {
                    xmlParts.push(openingTag + ' />');
                } else {
                    let descXml = `<Description>${description.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</Description>`;
                    xmlParts.push(openingTag + '>' + descXml + '</Code>');
                }
            });

            return [HEADER, ...xmlParts, FOOTER].join('\n');
        }

        /**
         * Triggers a browser download for the generated file content.
         * @param {string} content - The text content of the file to download.
         * @param {string} filename - The desired name of the downloaded file.
         */
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'application/xml;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>
